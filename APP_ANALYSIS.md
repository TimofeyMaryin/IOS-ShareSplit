# ShareSplit: полный объективный анализ приложения

**Область анализа:** только функционал, код, целостность данных, устойчивость.  
**Не учитывается:** графика/скриншоты для стора, политика конфиденциальности, тексты в личном кабинете разработчика.

---

## 1. Назначение и объём приложения

**ShareSplit** — менеджер общих подписок: учёт сервисов (Netflix, Spotify и т.д.), участников, долей, платежей и напоминаний.

**Реализованный функционал:**
- **Подписки:** название, иконка, категория, цена, валюта, цикл (месяц/год), дата следующего списания, активна/неактивна.
- **Участники:** имя, email, телефон; баланс (долг/переплата).
- **Доли (Share):** связь участник ↔ подписка, сумма доли.
- **Платежи (PaymentLog):** кто платил, за какую подписку, сумма, дата, флаг «Погашено».
- **Напоминания:** текст по шаблону, копирование и Share.
- **Аналитика:** burn rate, график по категориям (Charts), «Экономия» (разница между общей суммой подписок и долей пользователя).
- **Настройки:** валюта по умолчанию, имя в напоминаниях, тема (светлая/тёмная/системная).

Объём достаточный для законченного продукта; приложение не является заглушкой.

---

## 2. Архитектура данных (SwiftData)

**Модели:** `Member`, `Subscription`, `Share`, `PaymentLog`, `AppSettings`. Связи и типы полей заданы разумно.

**Плюсы:**
- Чёткое разделение сущностей, связи через отношения.
- `deleteRule`: cascade для Share/PaymentLog при удалении подписки; при удалении участника доли удаляются вручную, затем пересчитывается `totalCost` у затронутых подписок — висячих связей не остаётся.
- Вычисляемые поля (billingCycle, category, monthlyEquivalent) через свойства, в БД хранятся сырые строки.
- В `SettingsView` реализовано `ensureSingleSettings()`: при пустом списке создаётся одна запись, при нескольких — сохраняется запись с самым свежим `updatedAt`, остальные удаляются.

**Минусы:**
- «Долг» удаляемого участника исчезает (баланс никому не перераспределяется). Для бытового учёта долей это приемлемое упрощение.

**Вердикт по данным:** модель адекватна задаче; после удаления участника целостность данных (сумма долей и totalCost подписок) сохраняется.

---

## 3. Бизнес-логика

**Создание подписки (NewSubscriptionFlowView):**
- Три шага: сервис (пресет/свой), цена/валюта/цикл/дата, участники и разбивка (равные или свои суммы).
- Валидация: кнопка «Сохранить» активна только когда сумма долей совпадает с общей стоимостью (порог 0.01). Логика корректна.
- При сохранении: создаётся Subscription, на каждого участника — Share, у каждого участника увеличивается `totalBalance` на его долю. Реализация «участник должен X» верная.

**Редактирование подписки (EditSubscriptionView):**
- Редактирование: дата следующего списания, общая стоимость, валюта.
- Доли по участникам: изменение суммы с пересчётом баланса, удаление участника из подписки (removeShare + пересчёт баланса), добавление участника с суммой, кнопка «Пересчитать доли поровну». Валидация «сумма долей = totalCost» перед сохранением.
- После удаления участника из подписки `totalCost` не пересчитывается автоматически — пользователь должен либо вручную подогнать стоимость, либо нажать «Пересчитать доли поровну». Это осознанное решение (totalCost = цена подписки, а не сумма долей), но может быть неочевидно для пользователя.

**Платёж (AddPaymentLogView):**
- Выбор подписки, плательщика, суммы, валюты (подставляется из подписки), заметка.
- При сохранении: `member.totalBalance -= amount`. Логика «кто платил — уменьшил свой долг» верная. Связи PaymentLog ↔ Subscription и Member проставлены.
- Валидация: `canSave` требует amount > 0; отрицательная сумма не проверяется явно (при .number пользователь теоретически может ввести минус). Рекомендуется добавить проверку `amount > 0 && amount.isFinite`.

**Mark Settled (PaymentLogView):**
- Выставляется только `isSettled`; баланс уже скорректирован при создании платежа. Корректно.

**Удаление участника (MembersDirectoryView):**
- Удаляются все его Share, для каждой затронутой подписки пересчитывается `totalCost` = сумма оставшихся долей, затем удаляется сам Member. Сумма долей и totalCost остаются согласованными.

**Сделать подписку неактивной (SubscriptionDetailView):**
- Выполняется `subscription.isActive = false`. Явного вызова `modelContext.save()` нет; при использовании стандартного главного контекста SwiftData с autosave изменение должно сохраняться. Для однозначности и на случай отключённого autosave целесообразно добавить явный `try? modelContext.save()` после изменения.

**Вердикт по логике:** основной сценарий (создать подписку → разнести доли → логировать платежи → напоминания и аналитика), редактирование подписки и удаление участника реализованы согласованно. Обнаружены мелкие улучшения (валидация суммы платежа, явный save при деактивации подписки).

---

## 4. Экраны и навигация

| Экран | Назначение | Соответствие |
|-------|------------|--------------|
| Subscriptions Hub | Список активных подписок, burn rate, переход в детали/создание | Реализован, empty state |
| Subscription Detail | Участники и доли, дата/цикл, меню: Edit / Reminder / Mark Inactive | Реализован |
| New Subscription | Три шага, пресеты, цена/валюта/цикл/дата, доли, валидация | Реализован |
| Edit Subscription | Дата, стоимость, валюта, доли, добавление/удаление участников, «Пересчитать доли поровну» | Реализован |
| Members Directory | Список участников, баланс, добавление/редактирование/удаление (с подтверждением) | Реализован, empty state |
| Payment Log | Хронология платежей, добавление, свайп «Погашено» | Реализован, empty state |
| Reminder Constructor | Текст по шаблону, Copy и Share; отключение при пустых участниках | Реализован |
| Analytics | «Экономия», график по категориям (Charts) | Реализован |
| Settings | Валюта, имя в напоминаниях, тема, версия; единственная запись настроек | Реализован |

Навигация: TabView с пятью вкладками, внутри NavigationStack и navigationDestination. Переходы между экранами согласованы.

**Вердикт по экранам:** заявленный функционал присутствует; при удалении участника подписки остаются в согласованном состоянии.

---

## 5. Граничные случаи и устойчивость

- **Пустые списки:** Hub, Members, Payment Log используют ContentUnavailableView и понятные действия (добавить подписку/участника/платёж). Аналитика и настройки при отсутствии данных не ломаются.
- **Reminder при пустых участниках:** текст «Добавьте участников…», кнопки Copy/Share отключены.
- **Analytics без имени в настройках:** «Экономия» считается от полной суммы подписок (userShareTotal = 0), подпись объясняет, что нужно указать имя.
- **Удаление участника с долями:** крашей нет; у затронутых подписок пересчитывается totalCost = сумма оставшихся долей.
- **SubscriptionPresets.all.first!:** массив статический и непустой, падения не будет.
- **settingsList.first:** единственность записи обеспечивается в ensureSingleSettings(); при нескольких записях сохраняется запись с самым свежим updatedAt.
- **ReminderConstructorView:** используется force unwrap (settings!) только после проверки settings?.userName.isEmpty == false; логически безопасно, но можно заменить на optional binding для чистоты кода.
- **Точка входа (App):** при неудачном создании ModelContainer вызывается fatalError — при проблемах с миграцией или хранилищем приложение упадёт. Для релиза на чистых устройствах обычно приемлемо; при желании можно заменить на показ ошибки пользователю.

Явных крашей в разобранных сценариях не выявлено.

---

## 6. Соответствие Guideline 4.2 (минимальная функциональность)

- Приложение не заглушка: полный цикл — подписки, участники, доли, платежи, напоминания, аналитика, настройки, редактирование подписок.
- Это менеджер подписок и долей с понятной пользой для пользователя.
- Реальная ценность: учёт общих подписок, контроль долей и платежей, напоминания, отчёт по категориям и экономии.

**Вердикт:** по полноте и типу продукта приложение соответствует ожиданиям 4.2.

---

## 7. Рекомендации по улучшению (не блокеры для выхода)

1. **SubscriptionDetailView:** после `subscription.isActive = false` добавить `try? modelContext.save()` для явного сохранения.
2. **AddPaymentLogView:** ограничить сумму платежа: `amount > 0 && amount.isFinite` (и при необходимости верхнюю границу).
3. **EditSubscriptionView:** при удалении участника из подписки можно опционально предлагать пересчитать totalCost по оставшимся долям или оставить текущее поведение (ручная подгонка / «Поровну»).

---

## 8. Итоговая оценка шансов выхода (только по приложению и функционалу)

**Сильные стороны:**
- Полный набор экранов и сценариев: подписки, участники, доли, платежи, напоминания, аналитика, настройки, редактирование подписок (дата, стоимость, доли, состав участников, пересчёт равных долей).
- Корректная логика долей и балансов при создании, редактировании, платежах и удалении участника.
- Валидация при создании и редактировании подписки (сумма долей = общей стоимости).
- Empty states, нормальная навигация, использование SwiftData и системных контролов (в т.ч. Charts).
- Гарантия единственной записи настроек и предсказуемое поведение при пустых/минимальных данных.
- В рассмотренных сценариях явных падений не выявлено.

**Слабые стороны (приемлемые для бытового приложения):**
- «Долг» удалённого участника нигде не перераспределяется.
- Мелкие улучшения: явный save при деактивации подписки, валидация суммы платежа.

**Объективный вердикт:**

- **Шанс прохождения модерации по функционалу и полноте приложения:** **высокий (порядка 85–92%)**, при условии что в билде и при проверке ревьюером не проявятся краши или грубые ошибки в непроверенных сценариях.
- Основа для оценки: приложение законченное, с ясным назначением, полным циклом использования, редактированием подписок и согласованным удалением участников (totalCost пересчитывается). Риск отказа по «недостаточной функциональности» (4.2) низкий.
- Риски отказа в первую очередь не из-за логики приложения, а из-за возможного краша в редких сценариях (например, миграция хранилища, экзотические вводы) или замечаний по другим пунктам Guidelines (не входящим в рамки этого анализа).

Оценка дана только по коду и функционалу, без учёта дизайна и юридических текстов.
